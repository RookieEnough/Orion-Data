
name: Mirror APK (Manual)

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App ID'
        required: true
        type: string
      download_url:
        description: 'Download Link'
        required: true
        type: string
      mode:
        description: 'Mode'
        required: true
        default: 'direct'
        type: choice
        options:
        - direct
        - scrape
      wait_time:
        description: 'Wait Time (ms) for Scrape Mode'
        required: false
        default: '60000'
        type: string

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node & Tools
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Dependencies
        run: |
          # Force clean install to prevent cache issues
          rm -rf node_modules package-lock.json
          npm install
          
          # Install AAPT for APK parsing
          sudo apt-get update && sudo apt-get install -y aapt

      - name: Download
        env:
          CF_COOKIES: ${{ secrets.CF_COOKIES }}
        run: |
          APP_ID="${{ inputs.app_name }}"
          URL="${{ inputs.download_url }}"
          MODE="${{ inputs.mode }}"
          WAIT="${{ inputs.wait_time }}"
          TEMP_APK="temp.apk"
          
          echo "ðŸ“‚ Working Directory: $(pwd)"
          echo "ðŸ“¦ Node Modules: $(ls -d node_modules || echo 'MISSING')"
          
          if [[ "$MODE" == "scrape" ]]; then
             node .github/scripts/apk_hunter.js --url "$URL" --id "$APP_ID" --out "$TEMP_APK" --wait "$WAIT"
          else
             curl -L -A "Mozilla/5.0" -o "$TEMP_APK" "$URL"
          fi

      - name: Upload Debug Screenshots
        if: always() # Upload even if download fails
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: debug_screenshots/
          retention-days: 5

      - name: Verify & Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEMP_APK="temp.apk"
          if [[ ! -s "$TEMP_APK" ]]; then
            echo "::error::Download failed"
            exit 1
          fi
          
          # AAPT Dump to find Version Name
          VERSION=$(aapt dump badging "$TEMP_APK" | grep "package: " | sed -n "s/.*versionName='\([^']*\)'.*/\1/p")
          echo "Detected Version: $VERSION"
          
          TAG="${{ inputs.app_name }}-$VERSION"
          FINAL_NAME="${{ inputs.app_name }}-$VERSION.apk"
          mv "$TEMP_APK" "$FINAL_NAME"
          
          gh release create "$TAG" "$FINAL_NAME" --title "${{ inputs.app_name }} $VERSION" --notes "Manual Mirror via OrionStore" --latest || echo "Release likely exists"
