
name: Auto-Update Mirror

on:
  schedule:
    - cron: '0 0 * * *' # Daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          # Explicitly install packages to ensure they exist
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth
          sudo apt-get update && sudo apt-get install -y aapt

      - name: Run APK Hunter
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CF_COOKIES: ${{ secrets.CF_COOKIES }}
          NODE_PATH: ./node_modules
        run: |
          CONFIG_FILE="mirror_config.json"
          
          # Iterate config
          jq -c '.[]' "$CONFIG_FILE" | while read i; do
            APP_ID=$(echo "$i" | jq -r '.id')
            NAME=$(echo "$i" | jq -r '.name')
            URL=$(echo "$i" | jq -r '.downloadUrl')
            MODE=$(echo "$i" | jq -r '.mode // "direct"')
            WAIT_TIME=$(echo "$i" | jq -r '.wait // "30000"') # Default 30s if missing
            
            echo "------------------------------------------------"
            echo "ðŸ” Processing $NAME ($APP_ID)..."
            
            TEMP_APK="${APP_ID}-temp.apk"
            
            # --- DOWNLOAD STEP ---
            if [[ "$MODE" == "scrape" ]]; then
               echo "ðŸ•·ï¸  Mode: Scrape (Puppeteer) | Wait Limit: ${WAIT_TIME}ms"
               node .github/scripts/apk_hunter.js --url "$URL" --id "$APP_ID" --out "$TEMP_APK" --wait "$WAIT_TIME"
            else
               echo "â¬‡ï¸  Mode: Direct Download"
               curl -L -s -A "Mozilla/5.0" -o "$TEMP_APK" "$URL"
            fi
            
            # Check existence
            if [[ ! -s "$TEMP_APK" ]]; then
              echo "âš ï¸  Download failed. Skipping."
              continue
            fi

            # --- PROCESS & RELEASE STEP ---
            FILE_TYPE=$(file -b "$TEMP_APK")
            if [[ "$FILE_TYPE" == *"HTML"* ]]; then
               echo "âŒ Error: File is HTML. Skipping."
               rm "$TEMP_APK"
               continue
            fi

            VERSION_NAME=$(aapt dump badging "$TEMP_APK" | grep "package: " | sed -n "s/.*versionName='\([^']*\)'.*/\1/p")
            
            if [[ -z "$VERSION_NAME" ]]; then
              echo "âŒ Error: Could not read version from APK."
              rm "$TEMP_APK"
              continue
            fi
            
            echo "ðŸ“¦  Detected Version: $VERSION_NAME"
            TAG_NAME="${APP_ID}-${VERSION_NAME}"
            
            if gh release view "$TAG_NAME" > /dev/null 2>&1; then
              echo "âœ…  Already exists. Skipping."
              rm "$TEMP_APK"
            else
              echo "ðŸš€  New Update! Releasing $TAG_NAME..."
              FINAL_FILENAME="${APP_ID}-${VERSION_NAME}.apk"
              mv "$TEMP_APK" "$FINAL_FILENAME"
              gh release create "$TAG_NAME" "$FINAL_FILENAME" \
                --title "$NAME $VERSION_NAME" \
                --notes "Auto-mirrored via APK Hunter. Version: $VERSION_NAME" \
                --latest
            fi
            
            echo "------------------------------------------------"
          done

      - name: Upload Debug Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: debug_screenshots/
          retention-days: 3
